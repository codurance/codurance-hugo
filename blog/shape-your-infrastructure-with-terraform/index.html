<!DOCTYPE html>
<!--[if IE 8]> <html lang="en" class="ie8"> <![endif]-->
<!--[if IE 9]> <html lang="en" class="ie9">  <![endif]-->
<!--[if !IE]><!--> <html lang="en">  <!--<![endif]-->
<head>
    <title>Shape your infrastructure with Terraform | Codurance | London</title>
    
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Our team of dedicated software craftsmen provides consultancy, software development, and training services to clients seeking high quality development processes and software solutions.">
    <meta name="author" content="Codurance Ltd">

    
    <meta property="og:site_name" content="Codurance"/>
    <meta property="og:description" content="Our team of dedicated software craftsmen provides consultancy, software development, and training services to clients seeking high quality development processes and software solutions."/>
    <meta property="og:url" content="http://codurance.com/"/>
    <meta property="og:image" content="http://codurance.com/assets/img/codurance.png"/>

    
    <link rel="shortcut icon" href="/assets/img/favicon.ico">

    
    <link rel="stylesheet" href="/assets/plugins/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="/assets/css/style.css">
    <link rel="stylesheet" href="/assets/css/blocks.css">
    <link rel="stylesheet" href="/assets/css/blog.style.css">

    
    <link rel="stylesheet" href="/assets/plugins/line-icons/line-icons.css">
    <link rel="stylesheet" href="/assets/plugins/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" href="/assets/plugins/owl.carousel.2.0.0/assets/owl.carousel.css">

    
    <link rel="stylesheet" href="/assets/css/plugins.css">
    <link rel="stylesheet" href="/assets/css/app.css">
    <link rel="stylesheet" href="/assets/css/pages/blog.css">
    <link rel="stylesheet" href="/assets/css/theme-colors/orange.css">
    <link rel="stylesheet" href="/assets/css/headers/header-default.css">
    <link rel="stylesheet" href="/assets/css/footers/footer-v1.css">


    
    <link rel="stylesheet" href="/assets/css/custom.css">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.4.0/styles/idea.min.css">
    
    <link href='http://fonts.googleapis.com/css?family=Oxygen:700,400' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'>

    

    <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-46289079-1', 'codurance.com');
        ga('send', 'pageview');
    </script>
    <script src="/assets/js/highlight.pack.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>

    
    <script type="text/javascript">var switchTo5x=true;</script>
    <script type="text/javascript" src="http://w.sharethis.com/button/buttons.js"></script>
    <script type="text/javascript">stLight.options({publisher: "8b795ed1-9577-43d1-9e4e-55c54306336b", doNotHash: true, doNotCopy: false, hashAddressBar: false});</script>
</head>
<body>

<div class="wrapper">
    <div class="header no-topbar">
    <div class="container">
        
        <a class="logo" href="/">
            <img class="logo-header" src="/assets/img/codurance.png" alt="Codurance Logo" height="45px;">
        </a>
        

        
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-responsive-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="fa fa-bars"></span>
        </button>
        
    </div>

    
    <div class="collapse navbar-collapse mega-menu navbar-responsive-collapse">
        <div class="container">
            <ul class="nav navbar-nav">
                
                    <li class="dropdown">
    <a class="dropdown-toggle" data-toggle="dropdown">Services <i class="icon-angle-down">&nbsp;</i></a>
    <ul class="dropdown-menu">
        
            <li><a href="/services/software-creation">Software Creation</a></li>
        
            <li><a href="/services/training">Training</a></li>
        
    </ul>
</li>

                
                    <li><a href="/videos">Videos</a></li>
                
                    <li class="active"><a href="/blog">Blog</a></li>
                
                    <li class="dropdown">
    <a class="dropdown-toggle" data-toggle="dropdown">About Us  <i class="icon-angle-down">&nbsp;</i></a>
    <ul class="dropdown-menu">
        
            <li><a href="/aboutus/ourteam">Our Team</a></li>
        
            <li><a href="/aboutus/ourcompany">Our Company</a></li>
        
            <li><a href="/aboutus/ourpractices">Our Practices</a></li>
        
            <li><a href="http://www.meetup.com/london-software-craftsmanship">Our Community</a></li>
        
    </ul>
</li>

                
                    <li><a href="/work-with-us">Work with us</a></li>
                
                    <li><a href="/aboutus/contact">Contact Us</a></li>
                
            </ul>
        </div>
    </div>
</div>

    <div class="bg-color-light">
    <div class="container content-sm">
        <div class="row blog-page blog-item">
            
            <div class="col-md-9">
                
                <div class="news-v3 bg-color-white margin-bottom-30">
                    <div class="news-v3-in shareThisButtons">
                        <h1>Shape your infrastructure with Terraform</h1>
                        <ul class="list-inline posted-info">
                            <li>By <a class='author' href='/blog/author/robert-firek'>Robert Firek</a></li>
                            <li>Posted 30 June 2015</li>
                            <li>
                                
                                <a href="/tags/terraform/"><i class="fa fa-tags"></i><span class="blog-tag-margin"> Terraform</span></a>
                                
                                <a href="/tags/aws/"><i class="fa fa-tags"></i><span class="blog-tag-margin"> AWS</span></a>
                                
                                <a href="/tags/amazon-web-services/"><i class="fa fa-tags"></i><span class="blog-tag-margin"> Amazon-Web-Services</span></a>
                                
                                <a href="/tags/cloud/"><i class="fa fa-tags"></i><span class="blog-tag-margin"> Cloud</span></a>
                                
                            </li>
                        </ul>

                        

<p>The popularity of cloud infrastructure services has hugely increased over the last few years. Companies value the flexibility and reliability provided by such services. The simplicity of the solutions delivered by cloud providers should remove the burden from the shoulders of busy Dev and Ops people and give the possibility to focus on real customer&rsquo;s needs.</p>

<p>Unfortunately the reality is not necessarily so simple. When you start your journey in the cloud you will discover new challenges. One of these challenges will be connected with the creation and provisioning of your new infrastructure. Simple structures can be created within minutes using web pages or a CLI, but these are not the best ways to create a cloud with 100 machines.</p>

<p>AWS provides many different interfaces which allow automation of an infrastructure process. You can use a REST API or CLI to create your own script. This is probably the most flexible solution, but at the same time it can be time consuming.</p>

<p><a href="https://terraform.io/">Terraform</a> from HashiCorp can give you similar flexibility and at the same time you don&rsquo;t have to spend weeks to write bash or python scripts to provision your cloud.</p>

<h2 id="terraform-for-the-rescue-plan-apply-update-destroy">Terraform for the rescue - plan, apply, update, destroy.</h2>

<h3 id="plan">Plan</h3>

<h4 id="infrastructure-diagram">Infrastructure diagram</h4>

<p>
<img src="/assets/img/custom/blog/terraform/ShapeYourInfrastructure_VPC.png"  class="img img-responsive style-screengrab"/>

To demonstrate the use of Terraform we need to introduce some example infrastructure: let&rsquo;s provision a structure which will support a simple web service running in AWS. This web service will expose an API via a web proxy server. The service also requires a database and this database should have a separate EC2 instance to ease database maintenance. Instances responsible for business logic will be hidden in a private subnet and only the web proxy
server will be available to the wider internet. At the same time our service needs to connect to external resources - therefore a NAT instance will take the responsibility of managing network connections from within the private subnet. All of these resources will constitute a single <a href="http://aws.amazon.com/vpc/">Virtual Private Cloud</a> (VPC).</p>

<h4 id="provider">Provider</h4>

<p>We are now ready to introduce Terraform. We need to create configuration files which will describe components required to build our infrastructure. Configuration files can be written in <a href="https://terraform.io/docs/configuration/">HashiCorp Configuration Language</a> (similar to YAML) or JSON. All configuration files should have extension <strong><em>.tf</em></strong> and be stored in the same directory. Terraform automatically combines all resources defined in <strong><em>.tf</em></strong> files.</p>

<p>Before we add any resource we have know where our resources are going to exist. To do that we have to create a <em>provider</em> definition.</p>

<p>Terraform&rsquo;s provider is the mechanism used for managing resources, in our case we&rsquo;ll use the AWS provider. Our first configuration file might look like this:</p>

<p><strong><em>provider-config.tf</em></strong></p>

<pre><code class="language-javascript">provider &quot;aws&quot; {
    access_key = &quot;ACCESS_KEY_HERE&quot;
    secret_key = &quot;SECRET_KEY_HERE&quot;
    region     = &quot;eu-west-1&quot;
}
</code></pre>

<p>Obviously we don&rsquo;t want to keep our secrets in a file which will potentially be stored in version control.
We also want to have flexibility when we define a region in which we want to provision our environment. Terraform gives us the possibility to introduce variables.</p>

<p>First we have to declare the variables we want to use (see <strong><em>provider-variables.tf</em></strong>). The variables declaration introduces names, structure and default values for all variables used in the configuration file. We will override these default values later.</p>

<p><strong><em>provider-variables.tf</em></strong></p>

<pre><code class="language-javascript">variable &quot;provider&quot; {
    default = {
        access_key = &quot;not undefined yet&quot;
        secret_key = &quot;not undefined yet&quot;
        region     = &quot;not undefined yet&quot;
    }
}
</code></pre>

<p>Now we can update <strong><em>provider-config.tf</em></strong>.</p>

<p><strong><em>provider-config.tf</em></strong></p>

<pre><code class="language-javascript">provider &quot;aws&quot; {
    access_key = &quot;${var.provider.access_key}&quot;
    secret_key = &quot;${var.provider.secret_key}&quot;
    region     = &quot;${var.provider.region}&quot;
}
</code></pre>

<h4 id="vpc">VPC</h4>

<p>When we know how to connect to our provider we can introduce resources. A resource definition in Terraform contains information about the type of a resource and its name. Types of resources are predefined by Terraform and represent building elements which we can instantiate in the cloud. Each resource also has a predefined set of config properties which describe the resource in detail. For a full list of supported AWS resource types, see <a href="https://www.terraform.io/docs/providers/aws/">here</a>.</p>

<p><strong><em>Resource Syntax</em></strong></p>

<pre><code class="language-javascript">resource &lt;TYPE&gt; &lt;NAME&gt; {
    &lt;config_key&gt; = &lt;config_value&gt;
}
</code></pre>

<p>In our case we have to define a VPC for all our resources to reside in. We need to assign our VPC to a specific range of addresses by defining a <a href="https://en.wikipedia.org/wiki/Classless_Inter-Domain_Routing">CIDR</a> block. Each VPC also needs an internet gateway.</p>

<p>Once again instead of hardcoded values we will declare variables specific for our VPC definition.</p>

<p>We can also introduce a variable which defines the name of our environment. This name will allow us to tag resources and recognise to which environment a given resource belongs.</p>

<p><strong><em>environment-variables.tf</em></strong></p>

<pre><code class="language-javascript">variable &quot;environment_name&quot; {
    default = &quot;unknown-environment&quot;
}
</code></pre>

<p><strong><em>vpc-config.tf</em></strong></p>

<pre><code class="language-javascript">resource &quot;aws_vpc&quot; &quot;environment&quot; {
    cidr_block = &quot;${var.vpc.cidr_block}&quot;

    tags {
        Name        = &quot;${var.environment_name}-vpc&quot;
        Environment = &quot;${var.environment_name}&quot;
    }
}

resource &quot;aws_internet_gateway&quot; &quot;environment&quot; {
    vpc_id = &quot;${aws_vpc.environment.id}&quot;

    tags {
        Name        = &quot;${var.environment_name}-internet-gateway&quot;
        Environment = &quot;${var.environment_name}&quot;
    }
}
</code></pre>

<p><strong><em>vpc-variables.tf</em></strong></p>

<pre><code class="language-javascript">variable &quot;vpc&quot; {
    default = {
        owner_id = &quot;unknown&quot;
        cidr_block = &quot;10.changeit.0.0/16&quot;
    }
}
</code></pre>

<p>We can use the type of a resource and its name as a reference variable to access properties exposed by a given resource, as we did to reference the VPC id above. Some properties of a resource will be defined by Terraform during creation of the resource, like internal ids or names. Some are already defined in our scripts.</p>

<p>In the above example we assign an internet gateway to our VPC by referencing the property *<strong>id</strong> of <strong><em>aws_vpc</em></strong> resource with name <strong><em>environment</em></strong>.</p>

<h4 id="subnets">Subnets</h4>

<p>Our example VPC should contain two subnets. For each subnet we have to define a range of addresses available (CIDR block), an availability zone and of course we have to assign this subnet to the VPC. Again, we declare variables instead defining values directly in the configuration script.</p>

<p><strong><em>subnets-config.tf</em></strong></p>

<pre><code class="language-javascript">resource &quot;aws_subnet&quot; &quot;public-subnet&quot; {
    vpc_id            = &quot;${aws_vpc.environment.id}&quot;
    cidr_block        = &quot;${var.vpc_public_subnet.cidr_block}&quot;
    availability_zone = &quot;${var.vpc_public_subnet.availability_zone}&quot;

    tags {
        Name        = &quot;${var.environment_name}-public-subnet&quot;
        Environment = &quot;${var.environment_name}&quot;
    }
}

resource &quot;aws_subnet&quot; &quot;private-subnet&quot; {
    vpc_id            = &quot;${aws_vpc.environment.id}&quot;
    cidr_block        = &quot;${var.vpc_private_subnet.cidr_block}&quot;
    availability_zone = &quot;${var.vpc_private_subnet.availability_zone}&quot;

    tags {
        Name        = &quot;${var.environment_name}-private-subnet&quot;
        Environment = &quot;${var.environment_name}&quot;
    }
}
</code></pre>

<p><strong><em>subnets-variables.tf</em></strong></p>

<pre><code class="language-javascript">variable &quot;vpc&quot; {
    default = {
        owner_id = &quot;unknown&quot;
        cidr_block = &quot;10.changeit.0.0/16&quot;
    }
}

variable &quot;vpc_public_subnet&quot; {
    default = {
        cidr_block = &quot;10.changeit.0.0/24&quot;
        availability_zone = &quot;changeit&quot;
    }
}

variable &quot;vpc_private_subnet&quot; {
    default = {
        cidr_block = &quot;10.changeit.1.0/24&quot;
        availability_zone = &quot;changeit&quot;
    }
}
</code></pre>

<h4 id="route-tables">Route tables</h4>

<p>Each subnet in a VPC must be associated with a route table. This time we have an unusual situation. We have the reference to a resource which was not defined yet (<strong><em>${aws_instance.nat.id}</em></strong>). The order of files is not important for Terraform. It combines all files and based on that knowledge prepares a plan of execution. For that reason we can refer to resources which are defined in different files. Terraform will produce an error during creation if the resource is not defined anywhere.</p>

<p><strong><em>route_tables-config.tf</em></strong></p>

<pre><code class="language-javascript">resource &quot;aws_route_table&quot; &quot;public-subnet&quot; {
    vpc_id = &quot;${aws_vpc.environment.id}&quot;

    route {
        cidr_block = &quot;0.0.0.0/0&quot;
        gateway_id = &quot;${aws_internet_gateway.environment.id}&quot;
    }

    tags {
        Name        = &quot;${var.environment_name}-public-subnet-route-table&quot;
        Environment = &quot;${var.environment_name}&quot;
    }
}

resource &quot;aws_route_table_association&quot; &quot;public-subnet&quot; {
    subnet_id      = &quot;${aws_subnet.public-subnet.id}&quot;
    route_table_id = &quot;${aws_route_table.public-subnet.id}&quot;
}

resource &quot;aws_route_table&quot; &quot;private-subnet&quot; {
    vpc_id = &quot;${aws_vpc.environment.id}&quot;

    route {
        cidr_block  = &quot;0.0.0.0/0&quot;
        instance_id = &quot;${aws_instance.nat.id}&quot;
    }

    tags {
        Name        = &quot;${var.environment_name}-private-subnet-route-table&quot;
        Environment = &quot;${var.environment_name}&quot;
    }
}

resource &quot;aws_route_table_association&quot; &quot;private-subnet&quot; {
    subnet_id      = &quot;${aws_subnet.private-subnet.id}&quot;
    route_table_id = &quot;${aws_route_table.private-subnet.id}&quot;
}
</code></pre>

<h4 id="security-groups">Security groups</h4>

<p>A definition of any EC2 instance requires assigning it to a security group. Security groups are another type of resource in Terraform. Once again configuration of this resource type is straightforward. Depending on our needs we can define inbound (ingress) and outbound (egress) rules for the desired range of ports, protocols and addresses.</p>

<p><strong><em>security_groups-config.tf</em></strong></p>

<pre><code class="language-javascript">resource &quot;aws_security_group&quot; &quot;nat&quot; {
    name = &quot;${var.environment_name}-nat&quot;

    ingress {
        from_port   = 22
        to_port     = 22
        protocol    = &quot;tcp&quot;
        cidr_blocks = [&quot;0.0.0.0/0&quot;]
    }
(...)
    egress {
        from_port   = 80
        to_port     = 80
        protocol    = &quot;tcp&quot;
        cidr_blocks = [&quot;0.0.0.0/0&quot;]
    }
(...)
    vpc_id = &quot;${aws_vpc.development_environment.id}&quot;
    tags {
        Name        = &quot;${var.environment_name}-nat-security-group&quot;
        Environment = &quot;${var.environment_name}&quot;
    }
}

resource &quot;aws_security_group&quot; &quot;public&quot; {
    name = &quot;${var.environment_name}-public&quot;

    ingress {
        from_port   = 22
        to_port     = 22
        protocol    = &quot;tcp&quot;
        cidr_blocks = [&quot;0.0.0.0/0&quot;]
    }
(...)
    egress {
        from_port   = 0
        to_port     = 0
        protocol    = &quot;-1&quot;
        cidr_blocks = [&quot;0.0.0.0/0&quot;]
    }

    vpc_id = &quot;${aws_vpc.development_environment.id}&quot;
    tags {
        Name        = &quot;${var.environment_name}-public-security-group&quot;
        Environment = &quot;${var.environment_name}&quot;
    }
}

resource &quot;aws_security_group&quot; &quot;private&quot; {
    name = &quot;${var.environment_name}-private&quot;

    ingress {
        from_port   = 22
        to_port     = 22
        protocol    = &quot;tcp&quot;
        cidr_blocks = [&quot;${var.vpc_public_subnet.cidr_block}&quot;]
    }
(...)
    egress {
        from_port   = 0
        to_port     = 0
        protocol    = &quot;-1&quot;
        cidr_blocks = [&quot;0.0.0.0/0&quot;]
    }

    vpc_id = &quot;${aws_vpc.development_environment.id}&quot;
    tags {
        Name        = &quot;${var.environment_name}-private-security-group&quot;
        Environment = &quot;${var.environment_name}&quot;
    }
}
</code></pre>

<h4 id="ec2-instances">EC2 Instances</h4>

<p>With all the above resources declared we can finally define our EC2 instances.</p>

<p>Our NAT instance and web proxy instance require an Elastic IP (resource <strong><em>aws_eip</em></strong>). We also need to choose an instance type for each EC2 instance.</p>

<p><strong><em>instances-config.tf</em></strong></p>

<pre><code class="language-javascript">resource &quot;aws_instance&quot; &quot;nat&quot; {
    ami                         = &quot;${var.nat.ami_image}&quot;
    availability_zone           = &quot;${var.nat.availability_zone}&quot;
    instance_type               = &quot;t2.micro&quot;
    key_name                    = &quot;${var.nat.key_name}&quot;
    security_groups             = [&quot;${aws_security_group.nat.id}&quot;]
    subnet_id                   = &quot;${aws_subnet.public-subnet.id}&quot;
    associate_public_ip_address = true
    source_dest_check           = false

    tags {
        Name        = &quot;${var.environment_name}-nat&quot;
        Environment = &quot;${var.environment_name}&quot;
    }
}

resource &quot;aws_eip&quot; &quot;nat&quot; {
    instance = &quot;${aws_instance.nat.id}&quot;
    vpc      = true
}

resource &quot;aws_instance&quot; &quot;web-proxy&quot; {
    ami                         = &quot;${var.web-proxy.ami_image}&quot;
    availability_zone           = &quot;${var.web-proxy.availability_zone}&quot;
    instance_type               = &quot;t2.micro&quot;
    key_name                    = &quot;${var.web-proxy.key_name}&quot;
    security_groups             = [&quot;${aws_security_group.public.id}&quot;]
    subnet_id                   = &quot;${aws_subnet.public-subnet.id}&quot;
    associate_public_ip_address = true
    source_dest_check           = true

    tags {
        Name        = &quot;${var.environment_name}-web-proxy&quot;
        Environment = &quot;${var.environment_name}&quot;
    }
}

resource &quot;aws_eip&quot; &quot;web-proxy&quot; {
  instance = &quot;${aws_instance.web-proxy.id}&quot;
  vpc      = true
}

resource &quot;aws_instance&quot; &quot;database&quot; {
    ami                         = &quot;${var.database.ami_image}&quot;
    availability_zone           = &quot;${var.database.availability_zone}&quot;
    instance_type               = &quot;t2.micro&quot;
    key_name                    = &quot;${var.database.key_name}&quot;
    security_groups             = [&quot;${aws_security_group.private.id}&quot;]
    subnet_id                   = &quot;${aws_subnet.private-subnet.id}&quot;
    associate_public_ip_address = false
    source_dest_check           = true

    tags {
        Name        = &quot;${var.environment_name}-database&quot;
        Environment = &quot;${var.environment_name}&quot;
    }
}

resource &quot;aws_instance&quot; &quot;service&quot; {
    ami                         = &quot;${var.services.ami_image}&quot;
    availability_zone           = &quot;${var.services.availability_zone}&quot;
    instance_type               = &quot;t2.micro&quot;
    key_name                    = &quot;${var.services.key_name}&quot;
    security_groups             = [&quot;${aws_security_group.private.id}&quot;]
    subnet_id                   = &quot;${aws_subnet.private-subnet.id}&quot;
    associate_public_ip_address = false
    source_dest_check           = true
    count                       = 3

    tags {
        Name        = &quot;${var.environment_name}-service-${count.index}&quot;
        Environment = &quot;${var.environment_name}&quot;
    }
}
</code></pre>

<p><strong><em>instances-variables.tf</em></strong></p>

<pre><code class="language-javascript">variable &quot;nat&quot; {
    default = {
        ami_image         = &quot;ami-14913f63&quot;
        availability_zone = &quot;unknown&quot;
        key_name          = &quot;unknown&quot;
    }
}

variable &quot;web-proxy&quot; {
    default = {
        ami_image         = &quot;ami-2c90315b&quot;
        availability_zone = &quot;unknown&quot;
        key_name          = &quot;unknown&quot;
    }
}

variable &quot;database&quot; {
    default = {
        ami_image         = &quot;ami-2c90315b&quot;
        availability_zone = &quot;unknown&quot;
        key_name          = &quot;unknown&quot;
    }
}

variable &quot;services&quot; {
    default = {
        ami_image         = &quot;ami-2c90315b&quot;
        availability_zone = &quot;unknown&quot;
        key_name          = &quot;unknown&quot;
    }
}
</code></pre>

<h4 id="verify">Verify</h4>

<p>Our VPC definition is now ready. But how do we know that everything is ready for provisioning? We can verify our all hard work. All we have to do is ask Terraform to prepare a plan by executing the following command:</p>

<pre><code class="language-bash">$ terraform plan
</code></pre>

<p>Terraform will combine all available files and prepare an execution plan. This means that all definitions will be verified before you start provisioning your resources. The output from this command will also give us an overview of the kind of operations that will be performed during execution of the plan.</p>

<p>We have to remember that the plan only represents a dry run. We don&rsquo;t connect to AWS at this point and we will not find any errors which might occur in the cloud. For example a plan will not show any errors if you have already exceeded your limit of available EC2 instances.</p>

<h3 id="apply">Apply</h3>

<p>So far we used only default values to run our plan. It is not particularly useful when you want to create real environment.</p>

<p>To apply our execution plan we have to prepare a file which will contain the definitions of our variables. We can override default definitions by creating a file with extension <strong><em>.tfvariables</em></strong>. This file has the format of a regular Java property file where each key is the path of a variable and each value is the value assigned to it. An example variable file for our first environment might look like this:</p>

<p><strong><em>my_first_vpc_environment.tfvariables</em></strong></p>

<pre><code class="language-bash">environment_name = &quot;my_first_vpc_environment&quot;

provider.access_key = &quot;[MY_REAL_SECRET]&quot;
provider.secret_key = &quot;[MY_REAL_SECRET]&quot;
provider.region = &quot;eu-west-1&quot;

vpc.owner_id   = &quot;[MY_OWNER_ID]&quot;
vpc.cidr_block = &quot;10.0.0.0/16&quot;

vpc_public_subnet.cidr_block         = &quot;10.0.0.0/24&quot;
vpc_public_subnet.availability_zone  = &quot;eu-west-1a&quot;

vpc_private_subnet.cidr_block        = &quot;10.0.1.0/24&quot;
vpc_private_subnet.availability_zone = &quot;eu-west-1a&quot;

nat.key_name                = &quot;my_first_vpc_environment&quot;
nat.availability_zone       = &quot;eu-west-1a&quot;

web-proxy.key_name          = &quot;my_first_vpc_environment&quot;
web-proxy.availability_zone = &quot;eu-west-1a&quot;

database.key_name           = &quot;my_first_vpc_environment&quot;
database.availability_zone  = &quot;eu-west-1a&quot;

services.key_name           = &quot;my_first_vpc_environment&quot;
services.availability_zone  = &quot;eu-west-1a&quot;
</code></pre>

<p>We can verify the plan again and if we decide that we are ready we can apply it by executing the following command:</p>

<pre><code class="language-bash">$ terraform apply
</code></pre>

<p>Terraform will now connect to AWS and try to create all resources defined in Terraform scripts. The output of this command is a state file <strong><em>terraform.tfstate</em></strong> which contains all the information about the environment that we just provisioned. At the time of writing <a href="https://www.terraform.io/docs/state/index.html">the state file must be kept for future execution</a> (e.g. in your version control system), because Terraform uses it to determine differences between cloud state and the current definition stored in your scripts.</p>

<h3 id="change">Change</h3>

<p>Sometimes we have to change our environment. It requires just a change in your definition config. Based on
the state of your existing environment and your updated configuration, Terraform is able to prepare a new plan and apply changes to your infrastructure.</p>

<p>You can use the <strong><em>plan</em></strong> and <strong><em>apply</em></strong> commands in the same way as for a new environment. This time Terraform compares the state stored in the state file generated on the initial run, and plans/applies any newly-introduced changes to the configuration.</p>

<h3 id="destroy">Destroy</h3>

<p>Everything has to come to an end, sometime. When the time comes we can execute this command:</p>

<pre><code class="language-bash">$ terraform destroy
</code></pre>

<p>Terraform once again reuses our state file and will remove all resources defined there.</p>

<h2 id="what-s-next">What&rsquo;s next?</h2>

<p>In this post we only scratched the surface of Terraform. The AWS provider is one of <a href="https://www.terraform.io/docs/providers/index.html">many providers available</a>. Terraform allows us to combine different providers which give the possibility of provisioning environments across multiple cloud providers.</p>

<p>It also has other basic features. For example <a href="https://www.terraform.io/docs/configuration/outputs.html">outputs</a> give you the possibility to generate files based on any available variables and resource properties. You can use it to generate documentation, config files or just human readable text files.</p>

<p>Now our infrastructure can be managed in code. We can check it into source control, raise pull requests in GitHub and provide living documentation for our environment topology. We can lay the foundation for our deployments and tools like Puppet, Chef and Docker.</p>

<p>All code examples described here can be found <a href="https://github.com/robertfirek/ShapeYourInfrastructure">on GitHub</a>.</p>


                        

                        <div id="sharethisButtons">
                            <span class='pull-right st_twitter_large' displayText='Tweet' st_url='http://codurance.com/blog/shape-your-infrastructure-with-terraform/'></span>
                            <span class='pull-right st_linkedin_large' displayText='LinkedIn' st_url='http://codurance.com/blog/shape-your-infrastructure-with-terraform/'></span>
                            <span class='pull-right st_email_large' displayText='Email' st_url='http://codurance.com/blog/shape-your-infrastructure-with-terraform/'></span>
                            <span class='pull-right st_sharethis_large' displayText='ShareThis' st_url='http://codurance.com/blog/shape-your-infrastructure-with-terraform/'></span>
                        </div>
                    </div>
                </div>
                
                
                
                <div class = "blog-author bg-color-white margin-bottom-30">
                    <div class="headline headline-md margin-bottom-30">
                        <h2>About the author</h2>
                    </div>
                    <div class="row">
                        <div class="col-sm-3 pull-left">
                            <img class="img-responsive"  id="author-img" src="/assets/img/custom/team/robert_firek.jpg">
                        </div>
                        <div class="col-sm-9">
                            <div class="blog-author-desc">
                                <div class="overflow-h">
                                    <h4>Robert Firek</h4>
                                    
                                    <ul class="list-inline">
                                        <li><a href="https://twitter.com/intent/tweet?text=.%20@robertfirek%20Type%20your%20text%20here&url=http%3a%2f%2fcodurance.com%2fblog%2fshape-your-infrastructure-with-terraform%2f&via=codurance"><i class="fa fa-twitter"></i></a></li>
                                    </ul>
                                    
                                </div>
                                <p>Robert Firek is a software developer who has tasted many different flavours of programming. His broad range of experiences has helped to deliver quality software in many companies and organisations. He strives to create software according to the rule "Simplicity is the final achievement". As a Waterfall apostate, he encourages people to embrace Agile techniques.</p> <p>Robert is a member of the London Java Community and Wrocław Java User Group.</p>

                            </div>
                        </div>
                    </div>
                </div>
                
                
            </div>
            

            
            <div class="col-md-3">
                
                <div class="posts margin-bottom-40">
                    <div class="headline-v2">
                        <h2>Related Blogs</h2>
                    </div>

                        
                        
                        
                            
                            
                        
                            
                            
                        
                            
                            
                        
                            
                            
                        
                            
                            
                        
                            
                            
                        
                            
                            
                        
                            
                            
                        
                            
                            
                        
                            
                            
                        
                            
                            
                        
                            
                            
                        
                            
                            
                        
                            
                            
                        
                            
                            
                        
                            
                            
                        
                            
                            
                        
                            
                            
                        
                            
                            
                        
                            
                            
                        
                            
                            
                        
                            
                            
                        
                            
                            
                        
                            
                            
                        
                            
                            
                        
                            
                            
                        
                            
                            
                        
                            
                            
                        
                            
                            
                        
                            
                            
                        
                            
                            
                        
                            
                            
                        
                            
                            
                        
                            
                            
                        
                            
                            
                        
                            
                            
                        
                            
                            
                        
                            
                            
                        
                            
                            
                        
                            
                            
                        
                            
                            
                        
                            
                            
                        
                            
                            
                        
                            
                            
                        
                            
                            
                        
                            
                            
                        
                            
                            
                        
                            
                            
                        
                            
                            
                        
                            
                            
                                
                        <div class="blog-thumb blog-thumb-circle margin-bottom-15">
                            <div class="blog-thumb-hover">
                                <a href="/blog/cloud-application-design-considerations/">
                                    <img class="rounded-x" src="/assets/img/custom/blog/clouds.jpg" alt=""></img>
                                </a>
                                <a class="hover-grad" href="/blog/cloud-application-design-considerations/">
                                    <i class="fa fa-hand-spock-o"></i>
                                </a>
                            </div>
                            <div class="blog-thumb-desc">
                                <h3><a href="/blog/cloud-application-design-considerations/">Cloud Application Design Considerations</a></h3>
                                <ul class="blog-thumb-info">
                                    <li>
                                        Steve Lydford
                                    </li>
                                </ul>
                            </div>
                        </div>
                            
                        
                            
                            
                        
                            
                            
                        
                            
                            
                        
                            
                            
                        
                            
                            
                        
                            
                            
                        
                            
                            
                        
                            
                            
                        
                            
                            
                        
                            
                            
                        
                            
                            
                        
                            
                            
                        
                            
                            
                        
                            
                            
                        
                            
                            
                        
                            
                            
                        
                            
                            
                        
                            
                            
                        
                            
                            
                        
                            
                            
                        
                            
                            
                        
                            
                            
                        
                            
                            
                        
                            
                            
                        
                            
                            
                        
                            
                            
                        
                            
                            
                        
                            
                            
                        
                            
                            
                        
                            
                            
                        
                            
                            
                        
                            
                            
                        
                            
                            
                        
                            
                            
                        
                            
                            
                        
                            
                            
                        
                            
                            
                        
                            
                            
                        
                            
                            
                        
                            
                            
                        
                            
                            
                        
                            
                            
                        
                            
                            
                        
                            
                            
                        
                            
                            
                        
                            
                            
                        
                            
                            
                        
                            
                            
                        
                            
                            
                        
                            
                            
                        
                            
                            
                        
                            
                            
                        
                            
                            
                        
                            
                            
                        
                            
                            
                        
                            
                            
                        
                            
                            
                        
                            
                            
                        
                            
                            
                        
                            
                            
                        
                            
                            
                        
                            
                            
                        
                            
                            
                        
                            
                            
                        
                            
                            
                        
                            
                            
                        
                            
                            
                        
                            
                            
                        
                            
                            
                        
                            
                            
                        
                            
                            
                        
                            
                            
                        
                            
                            
                        
                            
                            
                        
                            
                            
                        
                            
                            
                        
                            
                            
                        
                            
                            
                        
                            
                            
                        
                            
                            
                        
                            
                            
                        
                            
                            
                        
                            
                            
                        
                            
                            
                        
                            
                            
                        
                            
                            
                        
                            
                            
                        
                            
                            
                        
                            
                            
                        
                            
                            
                        
                            
                            
                        
                            
                            
                        
                            
                            
                        
                            
                            
                        
                            
                            
                        
                            
                            
                        
                    </h1>
                </div>
                
                <div class="posts margin-bottom-40">
                    <div class="headline-v2"><h2>Recent Blogs</h2></div>
                    
                    <div class="blog-thumb blog-thumb-circle margin-bottom-15">
                        <div class="blog-thumb-hover">
                            <a href="/">
                                <img class="rounded-x" src="/assets/img/custom/blog/kafka.jpg" alt=""></img>
                            </a>
                            <a class="hover-grad" href="/blog/Publish-subscribe-model-in-Kafka/">
                                <i class="fa fa-hand-spock-o"></i>
                            </a>
                        </div>
                        <div class="blog-thumb-desc">
                            <h3><a href="/blog/Publish-subscribe-model-in-Kafka/">Publish-subscribe model in Kafka</a></h3>
                            <ul class="blog-thumb-info">
                                <li>
                                    Felipe Fernández
                                </li>
                            </ul>
                        </div>
                    </div>
                    
                    <div class="blog-thumb blog-thumb-circle margin-bottom-15">
                        <div class="blog-thumb-hover">
                            <a href="/">
                                <img class="rounded-x" src="/assets/img/custom/blog/2016-05-16-bowling.jpg" alt=""></img>
                            </a>
                            <a class="hover-grad" href="/blog/bowling-kata-in-clojure-fsharp-scala/">
                                <i class="fa fa-hand-spock-o"></i>
                            </a>
                        </div>
                        <div class="blog-thumb-desc">
                            <h3><a href="/blog/bowling-kata-in-clojure-fsharp-scala/">Bowling Kata in Clojure, F# and Scala</a></h3>
                            <ul class="blog-thumb-info">
                                <li>
                                    Sandro Mancuso
                                </li>
                            </ul>
                        </div>
                    </div>
                    
                    <div class="blog-thumb blog-thumb-circle margin-bottom-15">
                        <div class="blog-thumb-hover">
                            <a href="/">
                                <img class="rounded-x" src="/assets/img/custom/blog/2016-05-14-retrospective-park/hibiscus.jpg" alt=""></img>
                            </a>
                            <a class="hover-grad" href="/blog/retrospective-park/">
                                <i class="fa fa-hand-spock-o"></i>
                            </a>
                        </div>
                        <div class="blog-thumb-desc">
                            <h3><a href="/blog/retrospective-park/">A Retrospective in the Park</a></h3>
                            <ul class="blog-thumb-info">
                                <li>
                                    Matthew Butt
                                </li>
                            </ul>
                        </div>
                    </div>
                    
                    <div class="blog-thumb blog-thumb-circle margin-bottom-15">
                        <div class="blog-thumb-hover">
                            <a href="/">
                                <img class="rounded-x" src="/assets/img/custom/blog/penguins.jpg" alt=""></img>
                            </a>
                            <a class="hover-grad" href="/blog/initiative-circles/">
                                <i class="fa fa-hand-spock-o"></i>
                            </a>
                        </div>
                        <div class="blog-thumb-desc">
                            <h3><a href="/blog/initiative-circles/">Initiative Circles</a></h3>
                            <ul class="blog-thumb-info">
                                <li>
                                    Mashooq Badar
                                </li>
                            </ul>
                        </div>
                    </div>
                    
                    <div class="blog-thumb blog-thumb-circle margin-bottom-15">
                        <div class="blog-thumb-hover">
                            <a href="/">
                                <img class="rounded-x" src="/assets/img/custom/blog/aws-lambda.png" alt=""></img>
                            </a>
                            <a class="hover-grad" href="/blog/aws-lambdas/">
                                <i class="fa fa-hand-spock-o"></i>
                            </a>
                        </div>
                        <div class="blog-thumb-desc">
                            <h3><a href="/blog/aws-lambdas/">AWS Lambda for Beginners</a></h3>
                            <ul class="blog-thumb-info">
                                <li>
                                    Mashooq Badar
                                </li>
                            </ul>
                        </div>
                    </div>
                    
                    <div class="blog-thumb blog-thumb-circle margin-bottom-15">
                        <div class="blog-thumb-hover">
                            <a href="/">
                                <img class="rounded-x" src="/assets/img/custom/blog/machine.png" alt=""></img>
                            </a>
                            <a class="hover-grad" href="/blog/finite-state-machines-with-akka/">
                                <i class="fa fa-hand-spock-o"></i>
                            </a>
                        </div>
                        <div class="blog-thumb-desc">
                            <h3><a href="/blog/finite-state-machines-with-akka/">Finite state machines with Akka</a></h3>
                            <ul class="blog-thumb-info">
                                <li>
                                    Felipe Fernández
                                </li>
                            </ul>
                        </div>
                    </div>
                    
                    <div class="blog-thumb blog-thumb-circle margin-bottom-15">
                        <div class="blog-thumb-hover">
                            <a href="/">
                                <img class="rounded-x" src="/assets/img/custom/blog/code-smells_II.jpg" alt=""></img>
                            </a>
                            <a class="hover-grad" href="/blog/code-smells%E2%80%93part-two/">
                                <i class="fa fa-hand-spock-o"></i>
                            </a>
                        </div>
                        <div class="blog-thumb-desc">
                            <h3><a href="/blog/code-smells%E2%80%93part-two/">Code Smells – Part II</a></h3>
                            <ul class="blog-thumb-info">
                                <li>
                                    Ana Nogal
                                </li>
                            </ul>
                        </div>
                    </div>
                    
                    
                </div>
                
            </div>
            
        </div>
        
    </div>
    
</div>



    
<div id="footer-v1" class="footer-v1">
    <div class="footer">
        <div class="container">
            <div class="row">
                
                <div class="col-md-3 md-margin-bottom-40">
                    <a href="/">
                        <img id="logo-footer" class="footer-logo" src="/assets/img/footer-logo.png" alt="Codurance">
                    </a>
                    <p>Software is our passion. </p>
                    <p>We are software craftsmen. We build well-crafted software for our customers, we help developers to get better at their craft through training, coaching and mentoring, and we help companies get better at delivering software. </p>
                </div>
                

                
                <div class="col-md-3 md-margin-bottom-40">
                    <div class="posts">
                        <div class="headline"><h2>Latest Blogs</h2></div>
                        <ul class="list-unstyled latest-list">
                            
                            <li>
                                <a href="/blog/Publish-subscribe-model-in-Kafka/" alt="Publish-subscribe model in Kafka">Publish-subscribe model in Kafka</a>
                                <small>Felipe Fernández</small>
                            </li>
                            
                            <li>
                                <a href="/blog/bowling-kata-in-clojure-fsharp-scala/" alt="Bowling Kata in Clojure, F# and Scala">Bowling Kata in Clojure, F#...</a>
                                <small>Sandro Mancuso</small>
                            </li>
                            
                            <li>
                                <a href="/blog/retrospective-park/" alt="A Retrospective in the Park">A Retrospective in the Park</a>
                                <small>Matthew Butt</small>
                            </li>
                            
                        </ul>
                    </div>
                </div>
                

                
                <div class="col-md-3 md-margin-bottom-40">
                    <div class="headline"><h2>Useful Links</h2></div>
                    <ul class="list-unstyled link-list">
                        <li><a href="/services/software-creation">Software creation</a><i class="fa fa-angle-right"></i></li>
                        <li><a href="/services/training">Training</a><i class="fa fa-angle-right"></i></li>
                        <li><a href="/work-with-us">Work with us</a><i class="fa fa-angle-right"></i></li>
                        <li><a href="/aboutus/ourcompany">About us</a><i class="fa fa-angle-right"></i></li>
                        <li><a href="/policies/privacy">Privacy policy</a><i class="fa fa-angle-right"></i></li>
                    </ul>
                </div>
                

                
                <div class="col-md-3 map-img md-margin-bottom-40">
                    <div class="headline"><h2>Contact Us</h2></div>
                    <address class="md-margin-bottom-40">
                        <a href="https://www.google.co.uk/maps/place/I2+Office+Aldersgate/@51.5175798,-0.0978509,19z/data=!4m2!3m1!1s0x0000000000000000:0x71133b028b4f269d" target="_blank">200 Aldersgate, EC1A 4HD<br>
                            London, UK </a><br>
                        Phone: +44 203 440 4015 <br>
                        Email: <a href="mailto:hello@codurance.com" target="_blank" class="">hello@codurance.com</a>
                    </address>
                </div>
                
            </div>
        </div>
    </div>

    <div class="copyright">
        <div class="container">
            <div class="row">
                <div class="col-md-6">
                    <p>
                        Company Registration No: 8712584
                    </p>
                </div>

                
                <div class="col-md-6">
                    <ul class="footer-socials list-inline">
                        <li>
                            <a href="https://www.facebook.com/codurance/" class="tooltips" data-toggle="tooltip" data-placement="top" title="" data-original-title="Facebook" target="_blank">
                                <i class="fa fa-facebook"></i>
                            </a>
                        </li>
                        <li>
                            <a href="https://www.linkedin.com/company/codurance" class="tooltips" data-toggle="tooltip" data-placement="top" title="" data-original-title="Linkedin" target="_blank">
                                <i class="fa fa-linkedin"></i>
                            </a>
                        </li>
                        <li>
                            <a href="https://twitter.com/codurance" class="tooltips" data-toggle="tooltip" data-placement="top" title="" data-original-title="Twitter" target="_blank">
                                <i class="fa fa-twitter"></i>
                            </a>
                        </li>
                        <li>
                            <a href="/atom.xml" data-original-title="Feed" class="tooltips" data-toggle="tooltip" data-placement="top" title="" target="_blank">
                                <i class="fa fa-rss"></i>
                            </a>
                        </li>
                    </ul>
                </div>
                
            </div>
        </div>
    </div>
</div>

</div>

<script type="text/javascript" src="/assets/plugins/jquery/jquery.min.js"></script>
<script type="text/javascript" src="/assets/plugins/jquery/jquery-migrate.min.js"></script>
<script type="text/javascript" src="/assets/plugins/bootstrap/js/bootstrap.min.js"></script>
<script type="text/javascript" src="/assets/plugins/back-to-top.js"></script>

<script type="text/javascript" src="/assets/plugins/owl.carousel.2.0.0/owl.carousel.min.js"></script>
<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=true"></script>
<script type="text/javascript" src="/assets/plugins/gmap/gmap.js"></script>

<script type="text/javascript" src="/assets/js/custom.js"></script>

<script type="text/javascript" src="/assets/js/app.js"></script>
<script type="text/javascript" src="/assets/js/pages/index.js"></script>

<script type="text/javascript">
    jQuery(document).ready(function() {
        App.init();
        Contact.initMap();
    });
</script>
</body>
</html>

